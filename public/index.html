<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gemes. Meme games. Spread the meme.</title>
    <meta name="description" content="description"/>
    <meta name="author" content="author" />
    <meta name="keywords" content="keywords" />
    <style type="text/css">
        *,*::before,*::after{box-sizing:border-box;}*{margin:0;}body{line-height:1.5;-webkit-font-smoothing:antialiased;}img,picture,video,canvas,svg{display:block;max-width:100%;}input,button,textarea,select{font:inherit;}p,h1,h2,h3,h4,h5,h6{overflow-wrap:break-word;}#root,#__next{isolation:isolate;}

        @font-face {
            font-family: 'FucXed Caps Latin';
            src: url('fonts/fucxedcapslatin.otf') format('opentype'),
                url('fonts/fucxedcapslatin.woff') format('woff'),
                url('fonts/fucxedcapslatin.woff2') format('woff2');
        }

        .font {
            font-family: 'FucXed Caps Latin';
        }
    </style>

    <style>
        #canvas-container {
            overflow: hidden;
            width: 100%; /* Make sure it takes the full width of the screen */
        }

        #canvas {
            width: 100%; /* Set the canvas width to 100% of its container */
            height: auto; /* Automatically adjust the height to maintain aspect ratio */
        }
    </style>    
  </head>
  <body>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" integrity="sha256-xUHvBjJ4hahBW8qN9gceFBibSFUzbe9PNttUvehITzY=" crossorigin="anonymous"></script>

    <h1 class="font">Referred by <span id="referredby"></span></h1>

    <input id="yourid"></input>

    <button id="downloadButton">Save image</button>

    <div id="qrcode" style="display: none; opacity: 0.5"></div>

    <div id="canvas-container">
        <canvas id="canvas" width="2048" height="2048"></canvas>
    </div>

    
    <script>
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");

    $(function() {

        // REFERRAL CODE
        const pathname = window.location.pathname;
        console.log("Pathname: " + pathname);
        $("#referredby").text(pathname.replace("/", ""));

        // DRAW MEME

        var img = new Image();
        img.src = 'toxic-system.jpg';
        img.onload = function(){
            ctx.drawImage(img, 0, 0);

            draw_the_rest_on_top();
        };

        function draw_the_rest_on_top() {
            ctx.fillStyle = 'black';
            ctx.fillRect(739, 699, 570, 610);

            ctx.fillStyle = 'white';
            ctx.fillRect(749, 709, 550, 590);

            qrcodeGLOBAL = new QRCode(document.getElementById("qrcode"), {
                text: "http://jindo.dev.naver.com/collie",
                width: 1024,
                height: 1024,
                correctLevel : QRCode.CorrectLevel.H
            });

            const generatedQRcode = $("#qrcode").find("img")[0];
            generatedQRcode.onload = function() {
                ctx.drawImage(generatedQRcode, 774, 734, 500, 500);
            };
        }

    });

    function write_text_on_top(text) {
        ctx.fillStyle = 'black';
        ctx.fillRect(50, 30, 200, 50);

        ctx.font = '24px FucXed Caps Latin';
        ctx.fillStyle = 'white';
        ctx.fillText(text, 50, 50);
    }


    const inputElement = document.getElementById('yourid');
    inputElement.addEventListener('input', debounce(function() {
        console.log('Input changed:', inputElement.value);

        qrcodeGLOBAL.makeCode("https://gemes.world/" + inputElement.value);
        write_text_on_top("gemes.world/" + inputElement.value);

    }, 300));

    function debounce(func, delay) {
        let timeoutId;
        
        return function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
            func.apply(this, arguments);
            }, delay);
        };
    }
    
    const downloadButton = document.getElementById('downloadButton');
    downloadButton.addEventListener('click', () => {
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png'); // Convert canvas to data URL
        link.download = 'meme-games-gemes.png'; // Set the download attribute
        link.click(); // Simulate a click on the link to trigger download
    });    

    </script>

  </body>
</html>