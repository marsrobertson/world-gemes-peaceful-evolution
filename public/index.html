<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gemes. Meme games. Spread the meme.</title>
    <meta name="description" content="description"/>
    <meta name="author" content="author" />
    <meta name="keywords" content="keywords" />
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style type="text/css">
        /* reset */
        *,*::before,*::after{box-sizing:border-box;}*{margin:0;}body{line-height:1.5;-webkit-font-smoothing:antialiased;}img,picture,video,canvas,svg{display:block;max-width:100%;}input,button,textarea,select{font:inherit;}p,h1,h2,h3,h4,h5,h6{overflow-wrap:break-word;}#root,#__next{isolation:isolate;}

        body {
            background-color: gray;
            text-align: center;
        }
        input {
            background-color: #dadada;
            border: 0;
        }

        @font-face {
            font-family: 'FucXed Caps Latin';
            src: url('fonts/fucxedcapslatin.otf') format('opentype'),
                url('fonts/fucxedcapslatin.woff') format('woff'),
                url('fonts/fucxedcapslatin.woff2') format('woff2');
        }

        .font {
            font-family: 'FucXed Caps Latin';
        }

        #canvas-container {
            overflow: hidden;
            width: 100%; /* Make sure it takes the full width of the screen */
        }

        #canvas {
            width: 100%; /* Set the canvas width to 100% of its container */
            height: auto; /* Automatically adjust the height to maintain aspect ratio */
        }
    </style>
 
  </head>
  <body>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" integrity="sha256-xUHvBjJ4hahBW8qN9gceFBibSFUzbe9PNttUvehITzY=" crossorigin="anonymous"></script>

    <h1 class="font">Referred by: <span id="referredby"></span></h1>
    <h1 class="font">Your ID: 
        <input id="yourid" class="font" maxlength="20" autofocus pattern="^[a-zA-Z0-9_]+$" title="Only letters, digits, and underscores are allowed."></input>
    </h1>
    
    <br>
    <br>

    <!-- <img src="edit.svg" height="40" style="display: inline;"/> -->
    <!-- <button id="downloadButton">Save image</button> (or just right click to save the image) -->

    <div id="qrcode" style="display: none; opacity: 0.5"></div>

    <div id="canvas-container">
        <canvas id="canvas" width="2048" height="2048"></canvas>
    </div>

    <br>
    <br>
    <h1 class="font">Technical bits</h1>
    <p class="font">Check the <a href="https://github.com/marsrobertson/world-gemes-peaceful-evolution">GitHub repository</a></p>

    
    <script>
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");

    $(function() {

        // REFERRAL CODE (in the URL)
        let pathname = window.location.pathname;
        pathname = pathname.replace("/", ""); console.log("Pathname: " + pathname);
        if (pathname) {
            setCookie("referredby", pathname);
        }

        // IN THE COOKIES
        let youridCookie = getCookie("yourid");
        let referredbyCookie = getCookie("referredby");

        $("#yourid").val(youridCookie || "");

        referredby = referredbyCookie ? referredbyCookie : "default";
        $("#referredby").text(referredby);

        // DRAW MEME
        var img = new Image();
        img.src = 'toxic-system.jpg';
        img.onload = function(){
            ctx.drawImage(img, 0, 0);
            draw_the_rest_on_top();
        };

        function draw_the_rest_on_top() {
            ctx.fillStyle = 'black'; // so the QR code has nice boundary
            ctx.fillRect(739, 699, 570, 610);
            ctx.fillStyle = 'white';
            ctx.fillRect(749, 709, 550, 590);

            // Sorry not sorry for using GLOBAL variables, but actually I want to use it in other places (trust me bro, I know what I'm doing)
            qrcodeGLOBAL = new QRCode(document.getElementById("qrcode"), {
                text: "http://jindo.dev.naver.com/collie",
                width: 1024,
                height: 1024,
                correctLevel : QRCode.CorrectLevel.H
            });

            const generatedQRcode = $("#qrcode").find("img")[0];
            generatedQRcode.onload = function() {
                ctx.drawImage(generatedQRcode, 774, 734, 500, 500);
            };

            // Draw the 1st PART of THE URL
            write_username_on_top("gemes.world/" + (youridCookie || ""));

            // Draw the REFERRED BY
            ctx.font = '24px FucXed Caps Latin';
            ctx.fillStyle = 'black';
            const text = "?referredby=" + referredby;
            const textWidth = ctx.measureText(text).width; console.log(textWidth)
            const offset = Math.ceil(textWidth);
            
            ctx.fillText(text, 1279 - offset, 1285);
        }

    });

    function write_username_on_top(text) {
        ctx.fillStyle = 'white'; // Need to clear first
        ctx.fillRect(774, 1229, 525, 35);

        ctx.font = '24px FucXed Caps Latin';
        ctx.fillStyle = 'black';
        ctx.fillText(text, 774, 1259);
    }

    const inputElement = document.getElementById('yourid');
    inputElement.addEventListener('input', debounce(function() {
        console.log('Input changed:', inputElement.value);

        setCookie("yourid", inputElement.value.toLowerCase());
        qrcodeGLOBAL.makeCode("https://gemes.world/" + inputElement.value.toLowerCase() + "?referredby=" + referredby);
        write_username_on_top("gemes.world/" + inputElement.value.toLowerCase());

    }, 500));
   
    // const downloadButton = document.getElementById('downloadButton');
    // downloadButton.addEventListener('click', () => {
    //     const link = document.createElement('a');
    //     link.href = canvas.toDataURL('image/png'); // Convert canvas to data URL
    //     link.download = 'meme-games-gemes.png'; // Set the download attribute
    //     link.click(); // Simulate a click on the link to trigger download
    // });    

    // UTILITY FUNCTIONS
    function getCookie(cookieName) {
        const cookies = document.cookie.split(';');

        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim(); // Remove leading/trailing whitespace
            const cookieParts = cookie.split('=');
            const name = cookieParts[0];
            const value = cookieParts[1];

            if (name === cookieName) {
            // Return the cookie value if the name matches
            return decodeURIComponent(value);
            }
        }

        // Return null if the cookie is not found
        return null;
    }

    function setCookie(name, value, daysToExpire=10000) {
        const expirationDate = new Date();
        expirationDate.setTime(expirationDate.getTime() + (daysToExpire * 24 * 60 * 60 * 1000));
        
        const cookie = `${name}=${encodeURIComponent(value)}; expires=${expirationDate.toUTCString()}; path=/`;

        document.cookie = cookie;
    }

    function debounce(func, delay) {
        let timeoutId;
        
        return function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
            func.apply(this, arguments);
            }, delay);
        };
    }

    </script>

  </body>
</html>